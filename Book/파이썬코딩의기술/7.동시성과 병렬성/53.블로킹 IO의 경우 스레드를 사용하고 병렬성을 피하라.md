## 블로킹 I/O의 경우 스레드를 사용하고 병렬성을 피하라

- 파이썬의 표준 구현을 CPython이라고 한다. CPython은 두 단계를 거쳐 파이썬 프로그램을 실행한다
    - 1> 소스 코드를 구문 분석해서 바이트코드로 변환한다 (파이썬 3.6 부터는 16비트)
    - 2> CPython은 바이트코드를 스택 기반 인터프리터를 통해 실행한다
- 바이트코드 인터프리터에는 파이썬 프로그램이 실행되는 동안 일관성있게 유지해야 하는 상태가 존재 한다
    - CPython은 전역 인터프리터 락(GIL)이 라는 방법을 사용해 일관성을 강제로 유지한다

### GIL 락

- GIL은 상호 배제 락이며, CPython이 선점형 멀티스레드로 인행 영향을 받는 것을 방지한다
    - 선점형 멜티스레드 : 한 스레드가 다른 스레드의 실행을 중간에 인터럽트 시키고 제어를 가져올 수 있다
    - GIL은 인터럽트가 함부로 발생하는 것을 방지해, 인터프리터 상태가 제대로 유지되고 바이트코드 명령들이 제대로 실행되도록 만든다
- 부작용
    - C++나 자바로 작성된 프로그램에서 실행 스레드가 여럿 있다는 말은 이런 프로그램이 여러 CPU 코어를 동시에 활용할 수 있따는 뜻이다
    - 파이썬도 다중 실행 스레드를 지원하지만, GIL로 인해 여러 스레드 중 어느 하나만 앞으로 진행할 수 있다
    - 따라서 파이썬 프로그램의 속도를 높이고 병렬 처리를 수행하고자 스레드를 사용한다면 크게 실망할 것이다
- CPython에서도 다중 코어를 활용할 수 있는 방법이 있다. 하지만 이방법은 표준 Thread클래스를 사용하지 않으며 코딩하는 것이 어렵다

### 위 단점을 가진 쓰레드를 파이썬이 지원하는 이유

- 1> 다중 스레드를 사용하면 프로그램이 동시에 여러 일을 하는 것처럼 보이게 만들기 쉽다
    - 동시정 작업의 동작을 잘 조화시키는 코드를 직접 작성하기는 어렵다
    - 스레드를 사용하면 작성한 함수를 파이썬으로 동시에 실행시킬 수 있다
        - 파이썬이 GIL로 인해 스레드 중 어느 하나만 앞으로 진행할 수 있음에도 불구하고, CPython이 어느 정도 균일하게 각 스레드를 실행시켜주므로 다중 스레드를 통해 여러 함수를 동시에 실행할 수
          있다
- 2> 블로킹 I/O를 다루기 위해서다
    - 블로킹 I/O는 파이썬이 특정 시스템 콜을 사용할 때 일어난다
    - 파이썬 프로그램은 시스템 콜을 사용해 컴퓨터 운영체제가 자기 대신 외부 환경과 상호작용하도록 의뢰한다
        - 파일 쓰기/읽기, 네트워크, 디스플레이 장치와 통신 등등
    - 스레드를 사용하면 운영체제가 시스템 콜 요청에 응답하는 데 걸리는 시간 동안 파이썬 프로그램이 다른 일을 할 수 있다

#### 예시

```python
import time
import select


def slow_systemcall():
    select.select([socket.socket()], [], [], 0.1)


start = time.time()

for _ in range(5):
    slow_systemcall()
```

- 위 코드에서 문제점은 slow_systemcall함수가 실행되는 동안 프로그램이 아무런 진전을 이룰 수 없다는 것이다

#### 해결책

```python
threads = []
for _in range(5):
    thread = Thread(target=slow_systemcall)
    thread.start()
    thread.append(thread)
```

- 쓰레드를 사용하면 기다리는 동안 주 쓰레드는 다른일을 할 수 있다
- 위 코드는 GIL 로 인해 생기는 한계가 있더라도, 파이썬이 여러 스레드를 통해 시스템 콜을 병렬로 실행할 수 있음을 보여준다
    - GIL은 파이썬 프로그램이 병렬로 실행되지 못하게 막지만, 시스템 콜에 영향을 끼칠 수 없다
    - 이런 코드가 동작하는 이유는 파이썬 스레드가 시스템 콜을 하기 전에 GIL을 해제하고 시스템 콜에서 반환되자 마자 GIL을 획득하기 때문이다

#### 쓰레드 외에도 asyncio 내장 모듈 등 블로킹 I/O를 처리하는 방법이 많이 있다 